import pandas as pd
import os
import glob

# 1. 自动寻找当前文件夹下所有的 Excel 文件
file_list = glob.glob("*.xlsx")
if not file_list:
    print("错误：文件夹里没有找到 .xlsx 文件，请检查文件后缀！")
    exit()

print(f"正在读取并合并以下文件: {file_list}")

# 2. 读取并合并所有数据
all_dfs = []
for f in file_list:
    # 读取每个 Excel 的所有 Sheet
    dict_df = pd.read_excel(f, sheet_name=None)
    for sheet_name, df in dict_df.items():
        # 统一列名，寻找包含“设备”字样的列
        device_col = [c for c in df.columns if '设备' in str(c) or '名称' in str(c)]
        if device_col:
            temp_df = df[[device_col[0]]].copy()
            temp_df.columns = ['设备原始名称']
            all_dfs.append(temp_df)

df_final = pd.concat(all_dfs).drop_duplicates().reset_index(drop=True)

# 3. 定义全量国标映射字典 (覆盖 GBT 14885-2022 核心医疗类)
mapping = {
    'CT': ('A02320101', '医用 X 射线计算机断层扫描设备', '包含所有螺旋CT、排数CT'),
    'DR': ('A02320102', '医用 X 射线诊断设备', '包含DR、CR、移动X光机、胃镜X线机'),
    '磁共振': ('A02320201', '医用磁共振成像设备', '包含MRI、核磁共振'),
    'MRI': ('A02320201', '医用磁共振成像设备', '同上'),
    '超声': ('A02320301', '医用超声诊断设备', '包含彩超、B超、TCD'),
    '彩超': ('A02320301', '医用超声诊断设备', '同上'),
    '监护': ('A02320702', '多参数监护仪', '包含心电监护、多参数监控'),
    '心电': ('A02320701', '心电图机', '包含常规心电图、动态心电'),
    '脑电': ('A02320703', '脑电图机', '包含脑电图、睡眠监测'),
    '呼吸机': ('A02320801', '呼吸机', '包含有创、无创呼吸机'),
    '麻醉': ('A02320802', '麻醉机', '包含麻醉工作站'),
    '除颤': ('A02320803', '心脏除颤器', '包含AED、除颤监护仪'),
    '洗胃': ('A02320804', '洗胃机', '包含7D、全自动洗胃机'),
    '内窥镜': ('A02321203', '内窥镜及其辅助设备', '包含胃镜、肠镜、支气管镜'),
    '胃镜': ('A02321203', '内窥镜及其辅助设备', '同上'),
    '肠镜': ('A02321203', '内窥镜及其辅助设备', '同上'),
    '生化': ('A02321101', '全自动生化分析仪', '包含全自动生化分析系统'),
    '血液分析': ('A02321102', '血液分析仪器', '包含五分类、血球分析'),
    '尿液': ('A02321103', '尿液分析系统', '包含尿沉渣、尿分析'),
    '离心': ('A02321108', '离心机', '包含冷冻、高速离心机'),
    '手术床': ('A02321201', '手术室手术床', '包含电动、手动手术床'),
    '无影灯': ('A02321202', '手术室无影灯', '包含吊塔、LED无影灯'),
    '康复': ('A02321301', '康复训练设备', '包含机器人、训练器、减重架'),
    'MECT': ('A023299', '其他医疗设备', '精神科专用：电休克治疗仪'),
    '经颅磁': ('A023299', '其他医疗设备', '精神科专用：TMS'),
    '心理': ('A023299', '其他医疗设备', '心理测评、脑功能治疗'),
    '病床': ('A06080302', '钢塑病床', '通用家具：各类病床、摇床'),
    '治疗车': ('A02321299', '其他手术室、诊疗室设备', '医用手推车、抢救车')
}

# 4. 匹配逻辑
def do_match(name):
    name = str(name)
    for key, val in mapping.items():
        if key in name:
            return pd.Series(val)
    return pd.Series(['A023299', '其他医疗设备', '未匹配，请手动分类'])

df_final[['国标代码', '国标名称', '包含内容说明']] = df_final['设备原始名称'].apply(do_match)

# 5. 输出文件
output_file = '三院1205条全量映射结果.xlsx'
df_final.to_excel(output_file, index=False)
print(f"成功！已处理 {len(df_final)} 条不重复设备，请查看文件：{output_file}")
